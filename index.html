<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>J&M Finance OS V66 - Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette Fintech Modern */
            --bg-body: #F8FAFC;
            --sidebar: #1E293B;
            --sidebar-active: #334155;
            --surface: #FFFFFF;
            --surface-hover: #F1F5F9;
            
            --txt-main: #0F172A;
            --txt-sec: #64748B;
            --txt-light: #94A3B8;
            
            --border: #E2E8F0;
            
            /* Semantic Colors */
            --primary: #4F46E5; /* Indigo */
            --primary-light: #EEF2FF;
            --inc: #10B981; /* Emerald */
            --inc-bg: #ECFDF5;
            --exp: #EF4444; /* Red */
            --exp-bg: #FEF2F2;
            --warn: #F59E0B;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-body); 
            color: var(--txt-main); 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        /* Typography Utilities */
        .num { font-variant-numeric: tabular-nums; letter-spacing: -0.02em; }
        .u-caps { text-transform: uppercase; letter-spacing: 0.05em; font-size: 10px; font-weight: 700; color: var(--txt-sec); }

        /* --- SIDEBAR --- */
        .sidebar { 
            width: 240px; 
            background: var(--sidebar); 
            color: var(--txt-light); 
            display: flex; 
            flex-direction: column; 
            padding: 24px 16px; 
            z-index: 50; 
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }
        
        .brand { 
            color: white; 
            font-weight: 800; 
            font-size: 20px; 
            margin-bottom: 40px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            padding-left: 8px;
        }
        .brand span { color: var(--primary-light); font-weight: 400; opacity: 0.8; }

        .nav-item { 
            padding: 14px 16px; 
            border-radius: var(--radius); 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.2s; 
            margin-bottom: 4px; 
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        .sync-box { 
            margin-top: auto; 
            padding: 16px; 
            background: rgba(0,0,0,0.2); 
            border-radius: var(--radius); 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .status-row { display: flex; align-items: center; gap: 8px; font-size: 12px; margin-bottom: 10px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--txt-sec); transition: 0.3s; box-shadow: 0 0 8px rgba(0,0,0,0.5); }
        .btn-sync {
            background: var(--sidebar-active); border: 1px solid rgba(255,255,255,0.1); 
            color: white; font-size: 11px; padding: 8px; width: 100%; 
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        .btn-sync:hover { background: #475569; }

        /* --- MAIN AREA --- */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        .header { 
            height: 70px; 
            padding: 0 32px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border); 
            flex-shrink: 0; 
            z-index: 10;
        }

        .date-ctrl { 
            display: flex; 
            align-items: center; 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            padding: 4px; 
            box-shadow: var(--shadow-sm);
        }
        .btn-arr { 
            border: none; background: transparent; width: 32px; height: 32px; 
            cursor: pointer; color: var(--txt-sec); display: grid; place-items: center; 
            border-radius: 6px; transition: 0.2s;
        }
        .btn-arr:hover { background: var(--bg-body); color: var(--txt-main); }
        
        .curr-date { 
            font-weight: 700; font-size: 14px; color: var(--txt-main);
            padding: 0 16px; position: relative; min-width: 140px; text-align: center; 
            cursor: pointer;
        }
        .date-picker { position: absolute; inset:0; opacity:0; cursor:pointer; width: 100%; }
        
        .header-actions { display: flex; align-items: center; gap: 16px; }

        .tc-display { 
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center;
            padding: 0 12px; border-right: 1px solid var(--border); height: 40px;
        }
        .tc-val { 
            border: none; background: transparent; font-size: 14px; font-weight: 700; 
            text-align: right; width: 70px; color: var(--txt-main); font-family: 'Inter'; 
            padding: 0; cursor: text;
        }
        .tc-val:focus { border-bottom: 2px solid var(--primary); }

        .btn-new { 
            background: var(--txt-main); color: white; border: none; height: 40px; 
            padding: 0 20px; border-radius: 10px; font-weight: 600; font-size: 13px; 
            cursor: pointer; display: flex; align-items: center; gap: 8px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); transition: 0.2s;
        }
        .btn-new:hover { transform: translateY(-1px); box-shadow: 0 6px 8px -2px rgba(0,0,0,0.15); }

        /* --- CONTENT --- */
        .viewport { padding: 32px; overflow-y: auto; height: 100%; display: none; grid-template-rows: auto auto 1fr; gap: 24px; scroll-behavior: smooth; }
        .viewport.active { display: grid; }
        
        /* Dashboard Grid Layout */
        #view-home { grid-template-columns: 2fr 1.2fr; }

        /* KPI Cards */
        .kpi-row { grid-column: span 2; display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .kpi-card { 
            background: var(--surface); padding: 20px; border-radius: 16px; 
            border: 1px solid var(--border); box-shadow: var(--shadow-sm); 
            display: flex; flex-direction: column; justify-content: space-between;
            position: relative; overflow: hidden;
        }
        .kpi-card::after { content:''; position: absolute; top:0; right:0; width: 80px; height: 80px; background: linear-gradient(135deg, transparent, rgba(0,0,0,0.02)); border-radius: 0 0 0 100%; pointer-events: none; }
        
        .k-icon { font-size: 20px; margin-bottom: 12px; color: var(--txt-light); }
        .k-val { font-size: 24px; font-weight: 800; letter-spacing: -0.5px; z-index: 1; }
        .k-sub { font-size: 11px; font-weight: 500; color: var(--txt-sec); margin-top: 4px; }

        /* Ledger (Columns) */
        .ledger-wrapper { grid-column: 1; display: flex; flex-direction: column; gap: 16px; min-height: 0; }
        .ledger-cols { display: flex; gap: 24px; flex: 1; min-height: 0; }
        
        .col { 
            flex: 1; display: flex; flex-direction: column; background: var(--surface); 
            border-radius: 16px; border: 1px solid var(--border); overflow: hidden; 
            box-shadow: var(--shadow-sm);
        }
        .col-h { 
            padding: 16px 20px; font-size: 12px; font-weight: 700; letter-spacing: 0.05em; 
            text-transform: uppercase; border-bottom: 1px solid var(--border); 
            background: #FAFAFA; display: flex; justify-content: space-between; align-items: center;
        }
        .badge-count { background: rgba(0,0,0,0.05); padding: 2px 8px; border-radius: 10px; color: var(--txt-sec); font-size: 10px; }
        
        .tx-list { overflow-y: auto; flex: 1; padding: 0; }
        
        /* Transaction Card Styling */
        .tx-row { 
            padding: 14px 20px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: 0.15s; background: white;
        }
        .tx-row:hover { background: var(--surface-hover); padding-left: 24px; }
        .tx-row:last-child { border-bottom: none; }
        
        .tx-row.executed .tx-main { opacity: 0.4; }
        .tx-row.executed .tx-desc { text-decoration: line-through; }
        
        .tx-desc { font-weight: 600; font-size: 13px; color: var(--txt-main); margin-bottom: 4px; }
        .tx-meta { font-size: 11px; color: var(--txt-sec); display: flex; gap: 8px; align-items: center; }
        .tx-cat-pill { background: var(--bg-body); padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 10px; border: 1px solid var(--border); }
        .tx-link { color: var(--primary); font-weight: 600; display: flex; align-items: center; gap: 3px; font-size: 10px; background: var(--primary-light); padding: 1px 6px; border-radius: 4px;}

        /* Insights & Charts */
        .insights { grid-column: 2; grid-row: 2 / span 2; display: flex; flex-direction: column; gap: 24px; overflow-y: auto; padding-bottom: 10px; }
        .widget { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); padding: 20px; box-shadow: var(--shadow-sm); }
        .w-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .w-title { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--txt-sec); letter-spacing: 0.05em; }

        /* Allocation Accordion */
        .alloc-box { border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; overflow: hidden; transition: 0.2s; background: white; }
        .alloc-box:hover { border-color: #CBD5E1; }
        .alloc-box.open { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary-light); }
        
        .ab-head { padding: 12px 16px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .ab-head:hover { background: #FAFAFA; }
        .ab-prog-bg { height: 4px; width: 100%; background: #F1F5F9; margin-top: 8px; border-radius: 2px; overflow: hidden; }
        .ab-prog-fill { height: 100%; background: var(--inc); border-radius: 2px; }
        
        .ab-body { display: none; padding: 0; background: #FAFAFA; border-top: 1px solid var(--border); }
        .alloc-box.open .ab-body { display: block; animation: slideDown 0.2s ease; }
        .alloc-row { display: flex; align-items: center; padding: 10px 16px; border-bottom: 1px dashed var(--border); font-size: 12px; gap: 10px; }
        .alloc-row:last-child { border-bottom: none; }

        /* Chart Legend */
        .legend { margin-top: 20px; max-height: 240px; overflow-y: auto; padding-right: 5px; }
        .l-row { display: flex; justify-content: space-between; font-size: 12px; padding: 8px 0; border-bottom: 1px solid var(--bg-body); cursor: pointer; transition: 0.1s; border-radius: 4px; padding: 6px 8px;}
        .l-row:hover { background: var(--bg-body); }
        .l-dot { width: 8px; height: 8px; border-radius: 2px; margin-right: 8px; display: inline-block; }

        /* --- MODAL --- */
        .modal-ol { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .modal-ol.open { display: flex; opacity: 1; }
        
        .modal { background: white; width: 420px; padding: 32px; border-radius: 24px; box-shadow: var(--shadow-md); transform: scale(0.95); transition: transform 0.2s; }
        .modal-ol.open .modal { transform: scale(1); }
        
        .m-title { font-size: 18px; font-weight: 800; margin: 0 0 24px 0; color: var(--txt-main); }
        
        .form-group { margin-bottom: 16px; }
        .form-lbl { font-size: 11px; font-weight: 700; color: var(--txt-sec); margin-bottom: 6px; display: block; letter-spacing: 0.03em; }
        .form-in { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 14px; transition: 0.2s; background: #FAFAFA; color: var(--txt-main);}
        .form-in:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        
        .btn-save { background: var(--txt-main); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px; font-size: 14px; transition: 0.2s; }
        .btn-save:hover { background: #000; transform: translateY(-1px); }
        
        .btn-del { width: 100%; margin-top: 12px; border: none; background: transparent; color: var(--exp); font-weight: 600; cursor: pointer; font-size: 12px; padding: 8px; border-radius: 6px; }
        .btn-del:hover { background: var(--exp-bg); }

        /* Loader */
        .loader { position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:200; display:none; align-items:center; justify-content:center; backdrop-filter: blur(2px); flex-direction: column; gap: 15px;}
        .spinner { width: 40px; height: 40px; border: 4px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideDown { from { opacity:0; transform: translateY(-10px); } to { opacity:1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 900px) {
            #view-home { grid-template-columns: 1fr; }
            .kpi-row { grid-column: 1; grid-template-columns: repeat(2, 1fr); }
            .ledger-wrapper { grid-column: 1; }
            .insights { grid-column: 1; grid-row: auto; }
            .ledger-cols { flex-direction: column; }
        }
    </style>
</head>
<body>

<div id="loader" class="loader">
    <div class="spinner"></div>
    <div style="font-weight:600; font-size:13px; color:var(--txt-sec)">Sincronizando...</div>
</div>

<aside class="sidebar">
    <div class="brand"><i class="fas fa-layer-group"></i> J&M <span>FINANCE</span></div>
    
    <div class="nav-item active" id="nav-home" onclick="nav('home')">
        <i class="fas fa-chart-pie" style="width:20px"></i> Dashboard
    </div>
    <div class="nav-item" id="nav-admin" onclick="nav('admin')">
        <i class="fas fa-sliders-h" style="width:20px"></i> Admin
    </div>
    
    <div class="sync-box">
        <div class="status-row">
            <span class="status-dot" id="dot"></span> 
            <span id="st-txt" style="font-weight:600">Desconectado</span>
        </div>
        <button onclick="forceSync()" class="btn-sync">
            <i class="fas fa-sync-alt" style="margin-right:5px"></i> Actualizar
        </button>
    </div>
</aside>

<main class="main">
    <header class="header">
        <div class="date-ctrl">
            <button class="btn-arr" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
            <div class="curr-date">
                <span id="monthTxt">...</span>
                <input type="month" id="datePicker" class="date-picker" onchange="manualDate()">
            </div>
            <button class="btn-arr" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
        
        <div class="header-actions">
            <div class="tc-display">
                <span class="u-caps" style="font-size:9px">TC USD/ARS</span>
                <input type="number" id="usdRate" class="tc-val num" value="1200" onchange="updateMonthTC()">
            </div>
            <button class="btn-new" onclick="openModal()">
                <i class="fas fa-plus"></i> <span style="margin-left:4px">Nuevo</span>
            </button>
        </div>
    </header>

    <div id="view-home" class="viewport active">
        <div class="kpi-row">
            <div class="kpi-card">
                <i class="fas fa-wallet k-icon" style="color:var(--primary)"></i>
                <div class="k-val num" id="kpiBal">$0</div>
                <div class="k-sub">Balance Total</div>
            </div>
            <div class="kpi-card">
                <i class="fas fa-dollar-sign k-icon" style="color:#0EA5E9"></i>
                <div class="k-val num" id="kpiUsd">$0</div>
                <div class="k-sub">Est. USD (TC Mes)</div>
            </div>
            <div class="kpi-card" style="background:var(--inc-bg); border-color:rgba(16,185,129,0.2)">
                <i class="fas fa-arrow-down k-icon" style="color:var(--inc)"></i>
                <div class="k-val num" style="color:var(--inc)" id="sum-inc">$0</div>
                <div class="k-sub" style="color:var(--inc)">Ingresos Totales</div>
            </div>
            <div class="kpi-card" style="background:var(--exp-bg); border-color:rgba(239,68,68,0.2)">
                <i class="fas fa-arrow-up k-icon" style="color:var(--exp)"></i>
                <div class="k-val num" style="color:var(--exp)" id="sum-exp">$0</div>
                <div class="k-sub" style="color:var(--exp)">Gastos Totales</div>
            </div>
        </div>

        <div class="ledger-wrapper">
            <div class="ledger-cols">
                <div class="col">
                    <div class="col-h">
                        <span style="color:var(--inc)"><i class="fas fa-arrow-circle-down"></i> Ingresos</span>
                        <span class="badge-count" id="count-inc">0</span>
                    </div>
                    <div class="tx-list" id="list-inc"></div>
                </div>
                <div class="col">
                    <div class="col-h">
                        <span style="color:var(--exp)"><i class="fas fa-arrow-circle-up"></i> Egresos</span>
                        <span class="badge-count" id="count-exp">0</span>
                    </div>
                    <div class="tx-list" id="list-exp"></div>
                </div>
            </div>
        </div>

        <div class="insights">
            <div class="widget">
                <div class="w-header">
                    <div class="w-title"><i class="fas fa-project-diagram" style="margin-right:5px"></i> Asignación de Fondos</div>
                </div>
                <div id="allocList"></div>
            </div>

            <div class="widget">
                <div class="w-header">
                    <div class="w-title"><i class="fas fa-chart-pie" style="margin-right:5px"></i> Distribución de Gastos</div>
                    <button id="btnBackChart" onclick="resetChart()" style="border:none; background:rgba(99,102,241,0.1); color:var(--primary); font-weight:700; font-size:10px; padding:4px 8px; border-radius:4px; display:none; cursor:pointer;">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
                <div style="height:180px; position:relative;">
                    <canvas id="mainChart"></canvas>
                </div>
                <div id="chartLegend" class="legend"></div>
            </div>
        </div>
    </div>

    <div id="view-admin" class="viewport">
        <div class="widget" style="max-width:500px">
            <div class="w-header"><div class="w-title">Zona de Peligro</div></div>
            <p style="font-size:13px; color:var(--txt-sec); margin-bottom:20px;">
                Estas acciones afectan los datos del mes seleccionado actualmente (<span id="adminMonthTxt" style="font-weight:700"></span>).
            </p>
            <button onclick="clearMonth()" style="background:var(--exp); color:white; border:none; padding:16px; width:100%; border-radius:12px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; box-shadow: 0 4px 12px rgba(239,68,68,0.3);">
                <i class="fas fa-trash-alt"></i> BORRAR DATOS DEL MES
            </button>
        </div>
    </div>
</main>

<div class="modal-ol" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <form id="txForm">
            <h3 class="m-title" id="modalTitle">Nueva Transacción</h3>
            
            <div class="row-2">
                <div class="form-group">
                    <label class="form-lbl">TIPO</label>
                    <div style="position:relative">
                        <select id="fType" class="form-in" onchange="setType(this.value)">
                            <option value="exp">Gasto</option>
                            <option value="inc">Ingreso</option>
                        </select>
                        <i class="fas fa-chevron-down" style="position:absolute; right:12px; top:14px; font-size:10px; pointer-events:none; color:var(--txt-sec)"></i>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-lbl">MONTO</label>
                    <input type="number" id="fAmount" class="form-in num" step="0.01" placeholder="0.00" required>
                </div>
            </div>

            <div class="row-2">
                <div class="form-group">
                    <label class="form-lbl">FECHA</label>
                    <input type="date" id="fDate" class="form-in" required>
                </div>
                <div class="form-group">
                    <label class="form-lbl">ESTADO</label>
                    <div style="padding:10px; border:1px solid var(--border); border-radius:10px; background:#FAFAFA; display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" id="fExec" style="accent-color:var(--primary); width:16px; height:16px;">
                        <span style="font-size:12px; font-weight:600;">Ejecutado</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-lbl">CATEGORÍA</label>
                <div style="position:relative">
                    <select id="fCat" class="form-in" onchange="renderConcepts()"></select>
                    <i class="fas fa-chevron-down" style="position:absolute; right:12px; top:14px; font-size:10px; pointer-events:none; color:var(--txt-sec)"></i>
                </div>
            </div>

            <div class="form-group">
                <label class="form-lbl">CONCEPTO</label>
                <div style="position:relative">
                    <select id="fConcept" class="form-in" onchange="checkCustom()"></select>
                    <i class="fas fa-chevron-down" style="position:absolute; right:12px; top:14px; font-size:10px; pointer-events:none; color:var(--txt-sec)"></i>
                </div>
                <input type="text" id="fCustom" class="form-in" style="margin-top:8px; display:none;" placeholder="Escribe el concepto...">
            </div>

            <div class="form-group" id="linkGroup">
                <label class="form-lbl" style="color:var(--primary)">ASIGNAR A INGRESO (FUENTE)</label>
                <div style="position:relative">
                    <select id="fLink" class="form-in" style="border-color:var(--primary-light); background:var(--primary-light); color:var(--primary); font-weight:600;"></select>
                    <i class="fas fa-link" style="position:absolute; right:12px; top:14px; font-size:10px; pointer-events:none; color:var(--primary)"></i>
                </div>
            </div>

            <button type="submit" class="btn-save">GUARDAR REGISTRO</button>
            <button type="button" id="btnDel" class="btn-del" style="display:none;" onclick="delTx()">Eliminar Registro</button>
        </form>
    </div>
</div>

<script>
    // --- LÓGICA ORIGINAL INTACTA (SOLO CAMBIOS EN RENDERIZADO VISUAL) ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    // Nueva paleta de colores para gráficos más profesional
    const COLORS = ['#6366F1','#EC4899','#10B981','#F59E0B','#EF4444','#8B5CF6','#06B6D4','#84CC16', '#14B8A6', '#F43F5E'];

    let appData = { txs: [], cats: { exp:[], inc:[] }, concepts: {}, rates: {} };
    let currentDate = new Date(); currentDate.setDate(1);
    let editId = null, chartInstance = null, drillCat = null;

    const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    window.onload = () => {
        updateDateUI();
        forceSync();
    };

    async function forceSync() {
        showLoad(true); setStatus("Sincronizando...", "#F59E0B");
        try {
            const r = await fetch(API_URL);
            const d = await r.json();
            if(d && d.txs) { 
                appData = d; 
                if(!appData.rates) appData.rates = {};
                loadMonthData(); 
                setStatus("Conectado", "#10B981"); 
            }
        } catch(e) { setStatus("Offline", "#EF4444"); }
        showLoad(false);
    }

    async function saveData() {
        showLoad(true);
        try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); loadMonthData(); } 
        catch(e){ alert('Error al guardar'); } 
        showLoad(false);
    }

    function loadMonthData() {
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth() + 1;
        const monthKey = `${y}-${m.toString().padStart(2,'0')}`;

        // TC Independiente
        const currentTC = appData.rates[monthKey] || 1200;
        document.getElementById('usdRate').value = currentTC;

        const txs = appData.txs.filter(t => {
            if(t.deletedAt) return false;
            const p = t.date.split('-'); 
            return parseInt(p[0]) === y && parseInt(p[1]) === m;
        });

        txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);
        
        renderLists(txs);
        calcKPI(txs, currentTC);
        renderAlloc(txs);
        renderChart(txs);
    }

    function updateMonthTC() {
        const y = currentDate.getFullYear();
        const m = currentDate.getMonth() + 1;
        const monthKey = `${y}-${m.toString().padStart(2,'0')}`;
        appData.rates[monthKey] = parseFloat(document.getElementById('usdRate').value) || 1200;
        saveData();
    }

    function calcKPI(txs, tc) {
        const inc = txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
        const exp = txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
        const bal = inc - exp;
        document.getElementById('sum-inc').innerText = '$' + fmt(inc);
        document.getElementById('sum-exp').innerText = '$' + fmt(exp);
        document.getElementById('kpiBal').innerText = '$' + fmt(bal);
        document.getElementById('kpiBal').style.color = bal >= 0 ? 'var(--inc)' : 'var(--exp)';
        document.getElementById('kpiUsd').innerText = 'USD ' + fmt(bal/tc);
        document.getElementById('kpiUsd').style.color = bal >= 0 ? 'var(--inc)' : 'var(--exp)';
        
        // Contadores badge
        document.getElementById('count-inc').innerText = txs.filter(t=>t.type=='inc').length;
        document.getElementById('count-exp').innerText = txs.filter(t=>t.type=='exp').length;
    }

    function renderLists(txs) {
        const lI = document.getElementById('list-inc'); const lE = document.getElementById('list-exp');
        lI.innerHTML=''; lE.innerHTML='';
        
        // Helpers para visualizacion vacia
        const emptyHTML = '<div style="padding:20px; text-align:center; color:var(--txt-light); font-size:12px; font-style:italic;">Sin registros este mes</div>';
        let hasInc = false, hasExp = false;

        let rb = 0; // Running Balance para la columna de gastos
        txs.forEach(t => {
            if(t.type=='inc') rb += t.amount; else rb -= t.amount;
            
            // Subtexto mejorado
            const sub = t.type=='exp' ? `<div style="font-size:10px; margin-top:2px; font-weight:600; color:${rb>=0?'var(--inc)':'var(--exp)'}">Quedan: $${fmt(rb)}</div>` : '';
            
            // Link visual
            const linkName = (t.linkId && appData.txs.find(x=>x.id==t.linkId)) ? appData.txs.find(x=>x.id==t.linkId).desc : null;
            const linkHtml = (t.type=='exp' && linkName) ? `<div class="tx-link"><i class="fas fa-link"></i> ${linkName}</div>` : '';
            
            const div = document.createElement('div');
            div.className = `tx-row ${t.exec ? 'executed' : ''}`;
            div.onclick = () => editTx(t.id);
            
            // Template mejorado
            div.innerHTML = `
                <div class="tx-main">
                    <div class="tx-desc">${t.desc}</div>
                    <div class="tx-meta">
                        <span class="tx-cat-pill">${t.cat}</span>
                        <span><i class="far fa-calendar"></i> ${t.date.split('-')[2]}</span>
                        ${linkHtml}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="color:var(--${t.type}); font-weight:700; font-size:14px;" class="num">$${fmt(t.amount)}</div>
                    ${sub}
                </div>`;
            
            if(t.type=='inc') { lI.appendChild(div); hasInc=true; } 
            else { lE.appendChild(div); hasExp=true; }
        });

        if(!hasInc) lI.innerHTML = emptyHTML;
        if(!hasExp) lE.innerHTML = emptyHTML;
    }

    function renderAlloc(txs) {
        const c = document.getElementById('allocList'); c.innerHTML='';
        const incs = txs.filter(t=>t.type=='inc');
        const exps = txs.filter(t=>t.type=='exp');
        
        if(incs.length === 0) {
            c.innerHTML = '<div style="padding:15px; font-size:12px; color:var(--txt-sec);">Agrega ingresos para ver la asignación.</div>';
            return;
        }

        incs.forEach(inc => {
            const subs = exps.filter(e=>e.linkId==inc.id);
            const spent = subs.reduce((a,b)=>a+b.amount,0);
            const rem = inc.amount - spent;
            const pct = Math.min(100, Math.round((spent / inc.amount) * 100));
            
            let rows = '';
            subs.forEach(s => rows += `
                <div class="alloc-row ${s.exec?'executed':''}" onclick="editTx(${s.id})">
                    <span style="color:var(--txt-light); font-family:monospace;">${s.date.split('-')[2]}</span>
                    <span style="flex:1; font-weight:500;">${s.desc}</span>
                    <b class="num">$${fmt(s.amount)}</b>
                </div>`);

            // Barra de progreso y colores dinamicos
            const barColor = rem < 0 ? 'var(--exp)' : (pct > 90 ? 'var(--warn)' : 'var(--inc)');
            
            c.innerHTML += `
                <div class="alloc-box">
                    <div class="ab-head" onclick="this.parentElement.classList.toggle('open')">
                        <div style="width:100%">
                            <div style="display:flex; justify-content:space-between; font-size:13px; font-weight:600; color:var(--txt-main);">
                                <span>${inc.desc}</span>
                                <span class="num">$${fmt(inc.amount)}</span>
                            </div>
                            <div class="ab-prog-bg">
                                <div class="ab-prog-fill" style="width:${pct}%; background:${barColor}"></div>
                            </div>
                            <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:10px; font-weight:600; color:var(--txt-sec);">
                                <span>Gastado: $${fmt(spent)} (${pct}%)</span>
                                <span style="color:${rem>=0?'var(--inc)':'var(--exp)'}">Restan: $${fmt(rem)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="ab-body">${rows || '<div style="padding:10px 16px; font-size:11px; color:var(--txt-light)">Sin gastos asignados</div>'}</div>
                </div>`;
        });
    }

    function renderChart(txs) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if(chartInstance) chartInstance.destroy();
        const subset = txs.filter(t=>t.type=='exp');
        let map = {};
        
        // Lógica de Drilldown mantenida
        if(drillCat) {
            subset.filter(t=>t.cat==drillCat).forEach(t=>map[t.desc]=(map[t.desc]||0)+t.amount);
            document.getElementById('btnBackChart').style.display='inline-block';
        } else {
            subset.forEach(t=>map[t.cat]=(map[t.cat]||0)+t.amount);
            document.getElementById('btnBackChart').style.display='none';
        }
        
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const labels = entries.map(e=>e[0]);
        const data = entries.map(e=>e[1]);
        const tot = data.reduce((a,b)=>a+b,0);
        
        // Diseño de Chart.js mejorado
        chartInstance = new Chart(ctx, {
            type:'doughnut', 
            data:{
                labels, 
                datasets:[{
                    data, 
                    backgroundColor: COLORS, 
                    borderWidth: 2,
                    borderColor: '#ffffff',
                    hoverOffset: 4
                }]
            },
            options:{ 
                responsive:true, 
                maintainAspectRatio:false, 
                cutout:'75%', 
                plugins:{ legend:{display:false}, tooltip: { bodyFont: {family: 'Inter'}, boxPadding: 4 } }, 
                layout: { padding: 10 },
                onClick:(e,el)=>{
                    if(!drillCat && el.length){
                        drillCat=labels[el[0].index]; 
                        renderChart(txs);
                    }
                } 
            }
        });
        
        // Leyenda customizada
        const leg=document.getElementById('chartLegend'); leg.innerHTML='';
        if(entries.length === 0) leg.innerHTML = '<div style="text-align:center; font-size:11px; color:var(--txt-light); margin-top:20px;">Sin datos para graficar</div>';
        
        entries.forEach((en,i)=>{
            leg.innerHTML+=`
                <div class="l-row" onclick="if(!drillCat){drillCat='${en[0]}';renderChart(txs);}">
                    <div style="display:flex; align-items:center;">
                        <span class="l-dot" style="background:${COLORS[i%COLORS.length]}"></span>
                        <b style="color:var(--txt-main)">${en[0]}</b>
                    </div>
                    <div style="color:var(--txt-sec)">
                        <span class="num">$${fmt(en[1])}</span> 
                        <span style="font-size:10px; background:var(--bg-body); padding:1px 4px; border-radius:4px; margin-left:4px;">${tot>0?Math.round(en[1]/tot*100):0}%</span>
                    </div>
                </div>`;
        });
    }

    function resetChart(){ drillCat=null; loadMonthData(); }
    
    function updateDateUI(){ 
        document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; 
        document.getElementById('adminMonthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; 
    }
    
    function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
    function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
    function nav(v){ document.querySelectorAll('.viewport').forEach(x=>x.classList.remove('active')); document.getElementById(`view-${v}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); document.getElementById(`nav-${v}`).classList.add('active'); }
    function showLoad(s){ document.getElementById('loader').style.display=s?'flex':'none'; }
    function setStatus(t,c){ document.getElementById('st-txt').innerText=t; document.getElementById('dot').style.background=c; document.getElementById('dot').style.boxShadow = `0 0 8px ${c}`; }

    function openModal(){ editId=null; document.getElementById('txForm').reset(); document.getElementById('modalTitle').innerText='Nueva Transacción'; document.getElementById('btnDel').style.display='none'; document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; setType('exp'); document.getElementById('modalOverlay').classList.add('open'); }
    function closeModal(e){ if(e && e.target.id != 'modalOverlay' && !e.target.classList.contains('fa-times')) return; document.getElementById('modalOverlay').classList.remove('open'); }
    
    function setType(t){ 
        const cs = document.getElementById('fCat'); cs.innerHTML='';
        (appData.cats[t]||[]).forEach(c=>cs.add(new Option(c,c))); cs.add(new Option('+ Nueva Categoría...','new'));
        
        // UX: Mostrar/Ocultar asignación según tipo
        const lg = document.getElementById('linkGroup');
        if(t === 'inc') {
            lg.style.display = 'none';
        } else {
            lg.style.display = 'block';
        }

        renderConcepts(); renderLinkOpts();
    }
    
    function renderConcepts(){ 
        const c = document.getElementById('fCat').value;
        if(c=='new'){ const n=prompt('Nueva Categoría:'); if(n){ appData.cats[document.getElementById('fType').value].push(n); appData.concepts[n]=[]; saveData(); } return; }
        const cs = document.getElementById('fConcept'); cs.innerHTML='';
        (appData.concepts[c]||[]).forEach(x=>cs.add(new Option(x,x))); cs.add(new Option('+ Nuevo Concepto...','new_c'));
        checkCustom();
    }
    
    function checkCustom(){ document.getElementById('fCustom').style.display=document.getElementById('fConcept').value=='new_c'?'block':'none'; if(document.getElementById('fConcept').value=='new_c') document.getElementById('fCustom').focus(); }
    
    function renderLinkOpts(){ 
        const s = document.getElementById('fLink'); s.innerHTML='<option value="">-- Sin asignar --</option>';
        const y = currentDate.getFullYear(); const m = currentDate.getMonth()+1;
        // Ordenar ingresos por monto para facilitar selección
        const incs = appData.txs.filter(t=>!t.deletedAt && t.type=='inc' && parseInt(t.date.split('-')[1])==m).sort((a,b)=>b.amount-a.amount);
        incs.forEach(i=>s.add(new Option(`${i.desc} ($${fmt(i.amount)})`, i.id)));
    }
    
    document.getElementById('txForm').onsubmit = e => { 
        e.preventDefault();
        let desc = document.getElementById('fConcept').value;
        if(desc=='new_c') { desc = document.getElementById('fCustom').value; const cat = document.getElementById('fCat').value; if(desc && !appData.concepts[cat].includes(desc)) appData.concepts[cat].push(desc); }
        if(!desc) return alert("Ingresa un concepto");

        const tx = { 
            id: editId||Date.now(), 
            date: document.getElementById('fDate').value, 
            amount: parseFloat(document.getElementById('fAmount').value), 
            type: document.getElementById('fType').value, 
            cat: document.getElementById('fCat').value, 
            desc, 
            exec: document.getElementById('fExec').checked, 
            linkId: document.getElementById('fType').value=='exp'?document.getElementById('fLink').value:null, 
            deletedAt: null 
        };
        
        if(editId){ const i=appData.txs.findIndex(x=>x.id==editId); appData.txs[i]=tx; } else appData.txs.push(tx);
        saveData(); closeModal({target:document.getElementById('modalOverlay')});
    }
    
    function editTx(id){ 
        const t = appData.txs.find(x=>x.id==id); if(!t)return;
        editId=id; document.getElementById('modalTitle').innerText='Editar Transacción'; document.getElementById('btnDel').style.display='block';
        document.getElementById('fAmount').value=t.amount; document.getElementById('fDate').value=t.date; document.getElementById('fExec').checked=t.exec;
        
        // Truco para setear el select correctamente antes de renderizar subsiguientes
        document.getElementById('fType').value = t.type;
        setType(t.type); 
        
        document.getElementById('fCat').value=t.cat; 
        renderConcepts(); 
        
        if(t.desc) {
            // Verificar si el concepto existe, si no, es custom (legacy handling)
            const opts = Array.from(document.getElementById('fConcept').options).map(o=>o.value);
            if(opts.includes(t.desc)) {
                 document.getElementById('fConcept').value=t.desc;
            } else {
                 document.getElementById('fConcept').value='new_c';
                 checkCustom();
                 document.getElementById('fCustom').value=t.desc;
            }
        }

        if(t.type=='exp') document.getElementById('fLink').value=t.linkId||'';
        document.getElementById('modalOverlay').classList.add('open');
    }
    
    function delTx(){ if(confirm('¿Seguro que deseas eliminar este registro?')){ appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal({target:document.getElementById('modalOverlay')}); }}
    function clearMonth(){ if(confirm('ATENCIÓN: Esto borrará todos los registros visibles de este mes. ¿Continuar?')){ const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; appData.txs.forEach(t=>{ if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now(); }); saveData(); }}
</script>
</body>
</html>
