<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance OS - Nordic Minimal</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* --- NORDIC THEME --- */
            --bg-app: #ECEFF4;       /* Nord 6: Snow Storm */
            --bg-card: #FFFFFF;      /* Pure White */
            --sidebar: #2E3440;      /* Nord 0: Polar Night */
            --sidebar-act: #3B4252;  /* Nord 1: Lighter Polar */
            
            --txt-main: #2E3440;     /* Dark Slate */
            --txt-sec: #94A3B8;      /* Cool Grey */
            --border: #E2E8F0;       /* Subtle Cool Border */

            /* Brand Colors (Nordic Frost) */
            --primary: #5E81AC;      /* Nord 10: Frost Blue */
            
            /* Functional Colors (Muted for aesthetic but clear) */
            --success: #059669;      /* Emerald */
            --danger: #DC2626;       /* Red */
            --warning: #D97706;      /* Amber */
            
            --shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Ultra minimal shadow */
            --radius: 8px;           /* Tighter radius */
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-app); 
            color: var(--txt-main); 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            overflow: hidden; 
            font-size: 12px; /* Small font base */
            letter-spacing: -0.01em;
        }
        
        .num { font-variant-numeric: tabular-nums; letter-spacing: 0; font-weight: 500; }
        
        /* SCROLLBAR MINIMAL */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* --- SIDEBAR --- */
        .sidebar { width: 200px; background: var(--sidebar); display: flex; flex-direction: column; color: #D8DEE9; transition: 0.3s; flex-shrink: 0; }
        .logo-area { height: 50px; display: flex; align-items: center; padding: 0 20px; font-weight: 600; font-size: 13px; letter-spacing: 0.5px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ECEFF4; }
        .nav-items { padding: 10px; flex: 1; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 6px; cursor: pointer; color: #94A3B8; transition: 0.2s; font-weight: 400; margin-bottom: 2px; font-size: 12px; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--sidebar-act); color: #88C0D0; border-left: 3px solid #88C0D0; }
        .nav-item i { width: 16px; text-align: center; font-size: 13px; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* --- HEADER --- */
        .header { height: 50px; background: var(--bg-card); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; flex-shrink: 0; }
        .page-title { font-weight: 600; font-size: 14px; color: var(--txt-main); }
        .controls { display: flex; align-items: center; gap: 12px; }
        
        .date-ctrl { display: flex; align-items: center; background: var(--bg-app); border-radius: 6px; padding: 2px; }
        .d-btn { width: 24px; height: 24px; border: none; background: white; border-radius: 4px; cursor: pointer; color: var(--txt-sec); display: grid; place-items: center; font-size: 10px; border: 1px solid var(--border); }
        .d-display { width: 120px; text-align: center; font-weight: 500; font-size: 11px; position: relative; }
        .d-picker { position: absolute; inset:0; opacity:0; cursor: pointer; width: 100%; }

        /* --- KPI GRID --- */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 20px 24px 0 24px; flex-shrink: 0; }
        .kpi-card { background: var(--bg-card); padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: center; height: 80px; }
        .kpi-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .kpi-label { font-size: 10px; font-weight: 600; color: var(--txt-sec); text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 18px; font-weight: 600; color: var(--txt-main); }
        
        /* --- VIEWS --- */
        .view-container { padding: 20px 24px; overflow-y: auto; height: 100%; display: none; }
        .view-container.active { display: grid; }

        /* OPS VIEW */
        #view-ops { grid-template-columns: 1fr 1fr 1.2fr; gap: 20px; align-items: start; }
        
        .panel { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow); display: flex; flex-direction: column; height: calc(100vh - 200px); overflow: hidden; }
        .panel-head { padding: 10px 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #F8FAFC; min-height: 36px; }
        .ph-title { font-weight: 600; font-size: 11px; text-transform: uppercase; display: flex; align-items: center; gap: 6px; letter-spacing: 0.02em; }
        .panel-body { flex: 1; overflow-y: auto; padding: 0; }

        /* LIST ITEMS */
        .tx-row { padding: 8px 16px; border-bottom: 1px solid #F1F5F9; display: flex; justify-content: space-between; align-items: center; transition: 0.1s; cursor: pointer; }
        .tx-row:hover { background: #F8FAFC; }
        .tx-row:last-child { border-bottom: none; }
        .tx-row.executed { opacity: 0.5; filter: grayscale(1); } .tx-row.executed .tx-desc { text-decoration: line-through; }
        
        .tx-left { display: flex; flex-direction: column; gap: 2px; }
        .tx-desc { font-weight: 500; font-size: 12px; color: var(--txt-main); }
        .tx-meta { display: flex; gap: 6px; align-items: center; font-size: 10px; color: var(--txt-sec); }
        .badge { padding: 1px 6px; border-radius: 4px; font-size: 9px; font-weight: 500; border: 1px solid var(--border); background: #F8FAFC; color: var(--txt-sec); }
        
        /* ALLOCATION BARS */
        .alloc-item { padding: 10px 16px; border-bottom: 1px solid var(--border); }
        .ai-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-weight: 500; font-size: 11px; }
        .ai-bar-bg { height: 6px; background: #ECEFF4; border-radius: 3px; overflow: hidden; width: 100%; }
        .ai-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .ai-stats { display: flex; justify-content: space-between; margin-top: 4px; font-size: 10px; color: var(--txt-sec); }
        .ai-details { margin-top: 8px; padding: 8px; background: #F8FAFC; border-radius: 6px; display: none; border: 1px solid var(--border); }
        .alloc-item.open .ai-details { display: block; }
        
        /* CHARTS VIEW */
        #view-charts { grid-template-columns: 1fr 300px; grid-template-rows: 250px 1fr; gap: 20px; }
        .chart-card { background: var(--bg-card); border-radius: var(--radius); border: 1px solid var(--border); padding: 16px; box-shadow: var(--shadow); position: relative; display: flex; flex-direction: column; }
        .cc-full { grid-column: span 2; }
        .cc-title { font-weight: 600; font-size: 11px; color: var(--txt-sec); text-transform: uppercase; margin-bottom: 10px; display: flex; justify-content: space-between; letter-spacing: 0.5px; }
        .canvas-area { flex: 1; position: relative; min-height: 0; }
        
        .custom-legend { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .cl-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid transparent; font-size: 11px; }
        .cl-item:hover { background: #F8FAFC; border-color: var(--border); }
        .cl-dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; }

        /* --- FAB & MODAL --- */
        .fab { position: fixed; bottom: 24px; right: 24px; width: 48px; height: 48px; background: var(--primary); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 20px; box-shadow: 0 4px 12px rgba(94, 129, 172, 0.4); cursor: pointer; border: none; transition: 0.2s; z-index: 100; }
        .fab:hover { transform: translateY(-2px); background: #4C566A; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(46, 52, 64, 0.4); backdrop-filter: blur(2px); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal-overlay.open { display: flex; }
        .modal { background: white; width: 400px; border-radius: 12px; box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1); overflow: hidden; display: flex; flex-direction: column; max-height: 90vh; animation: fadeUp 0.2s ease-out; }
        
        @keyframes fadeUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .m-header { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #F8FAFC; }
        .m-title { font-weight: 600; font-size: 13px; color: var(--txt-main); }
        .m-body { padding: 20px; overflow-y: auto; }

        /* FORM STYLES */
        .type-selector { display: flex; background: var(--bg-app); padding: 3px; border-radius: 8px; margin-bottom: 16px; }
        .ts-btn { flex: 1; border: none; padding: 8px; border-radius: 6px; font-weight: 500; font-size: 11px; color: var(--txt-sec); cursor: pointer; background: transparent; transition: 0.2s; }
        .ts-btn.active { background: white; color: var(--txt-main); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ts-btn.active.inc { color: var(--success); }
        .ts-btn.active.exp { color: var(--danger); }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .f-group { margin-bottom: 12px; }
        .f-label { display: block; font-size: 10px; font-weight: 600; color: var(--txt-sec); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .f-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 12px; transition: 0.2s; background: #F8FAFC; color: var(--txt-main); }
        .f-input:focus { border-color: var(--primary); background: white; }
        
        .chips-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .chip { padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border); background: white; font-size: 11px; font-weight: 400; color: var(--txt-sec); cursor: pointer; transition: 0.1s; }
        .chip:hover { border-color: var(--txt-sec); }
        .chip.active { background: var(--sidebar); color: white; border-color: var(--sidebar); }
        .chip.add { border-style: dashed; color: var(--primary); }

        .btn-primary { width: 100%; background: var(--primary); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: 600; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: var(--sidebar); }

        @media (max-width: 1000px) {
            .sidebar { width: 50px; }
            .logo-area span, .nav-item span { display: none; }
            .nav-item { justify-content: center; padding: 12px 0; }
            #view-ops { grid-template-columns: 1fr; height: auto; display: flex; flex-direction: column; }
            .panel { height: auto; max-height: 400px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            #view-charts { grid-template-columns: 1fr; grid-template-rows: auto; }
            .kpi-card { height: 70px; }
        }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="logo-area">
        <i class="fas fa-cube" style="color:var(--primary); margin-right:10px;"></i> <span>Finance OS</span>
    </div>
    <div class="nav-items">
        <div class="nav-item active" onclick="nav('ops', this)">
            <i class="fas fa-columns"></i> <span>Operaciones</span>
        </div>
        <div class="nav-item" onclick="nav('charts', this)">
            <i class="fas fa-chart-pie"></i> <span>Análisis</span>
        </div>
        <div class="nav-item" onclick="nav('admin', this)">
            <i class="fas fa-cog"></i> <span>Ajustes</span>
        </div>
        <div class="nav-item" onclick="forceSync()">
            <i class="fas fa-sync-alt"></i> <span>Sync</span>
        </div>
    </div>
</aside>

<main class="main-content">
    
    <header class="header">
        <div class="page-title" id="pageTitle">Panel de Control</div>
        <div class="controls">
            <div style="font-size:11px; font-weight:500; color:var(--txt-sec)">TC: <input type="number" id="usdRate" value="1200" onchange="updateTC()" style="width:50px; border:none; background:transparent; font-weight:600; color:var(--txt-main); font-family:inherit;"></div>
            <div class="date-ctrl">
                <button class="d-btn" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                <div class="d-display"><span id="monthTxt">...</span><input type="month" id="datePicker" class="d-picker" onchange="manualDate()"></div>
                <button class="d-btn" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </header>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-top">
                <div class="kpi-label">Balance Neto</div>
            </div>
            <div class="kpi-value num" id="k-bal">$0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-top">
                <div class="kpi-label">Estimado USD</div>
            </div>
            <div class="kpi-value num" id="k-usd" style="color:var(--primary)">$0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-top">
                <div class="kpi-label">Ingresos</div>
            </div>
            <div class="kpi-value num" id="k-inc" style="color:var(--success)">$0</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-top">
                <div class="kpi-label">Gastos</div>
            </div>
            <div class="kpi-value num" id="k-exp" style="color:var(--danger)">$0</div>
        </div>
    </div>

    <div id="view-ops" class="view-container active">
        <div class="panel">
            <div class="panel-head">
                <span class="ph-title" style="color:var(--success)"><i class="fas fa-circle" style="font-size:6px; margin-right:4px;"></i> Ingresos</span>
                <span class="badge" id="c-inc">0</span>
            </div>
            <div class="panel-body" id="list-inc"></div>
        </div>

        <div class="panel">
            <div class="panel-head">
                <span class="ph-title" style="color:var(--danger)"><i class="fas fa-circle" style="font-size:6px; margin-right:4px;"></i> Gastos</span>
                <span class="badge" id="c-exp">0</span>
            </div>
            <div class="panel-body" id="list-exp"></div>
        </div>

        <div class="panel">
            <div class="panel-head">
                <span class="ph-title" style="color:var(--primary)"><i class="fas fa-chart-bar" style="font-size:10px; margin-right:4px;"></i> Asignación</span>
            </div>
            <div class="panel-body" id="list-alloc" style="padding:0;"></div>
        </div>
    </div>

    <div id="view-charts" class="view-container">
        <div class="chart-card">
            <div class="cc-title">Gastos por Categoría <button onclick="resetCharts()" style="border:none; background:none; color:var(--primary); cursor:pointer; font-size:10px;">RESET</button></div>
            <div style="display:flex; height:100%; gap:20px;">
                <div class="canvas-area"><canvas id="chartExp"></canvas></div>
                <div class="custom-legend" id="legExp" style="width:140px;"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="cc-title">Ingresos por Concepto</div>
            <div style="display:flex; height:100%; gap:20px; flex-direction:column;">
                <div class="canvas-area" style="max-height:150px;"><canvas id="chartInc"></canvas></div>
                <div class="custom-legend" id="legInc"></div>
            </div>
        </div>

        <div class="chart-card cc-full">
            <div class="cc-title">Flujo de Caja Diario</div>
            <div class="canvas-area"><canvas id="chartFlow"></canvas></div>
        </div>
    </div>

    <div id="view-admin" class="view-container">
        <div class="chart-card" style="max-width:400px; margin:0 auto; height:auto;">
            <div class="cc-title">Gestión de Datos</div>
            <div class="f-group">
                <label class="f-label">Importar mes anterior</label>
                <div style="display:flex; gap:10px;">
                    <input type="month" id="cloneSrc" class="f-input">
                    <button onclick="cloneMonth()" class="btn-primary" style="width:auto; padding:0 24px;">Copiar</button>
                </div>
            </div>
            <div style="height:1px; background:var(--border); margin:24px 0;"></div>
            <button onclick="clearMonth()" style="background:transparent; border:1px solid var(--danger); color:var(--danger); padding:12px; border-radius:8px; font-weight:600; cursor:pointer; width:100%; font-size:11px;">ELIMINAR DATOS DEL MES ACTUAL</button>
        </div>
    </div>

</main>

<button class="fab" onclick="openModal()"><i class="fas fa-plus"></i></button>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="m-header">
            <span class="m-title" id="mTitle">Nuevo Movimiento</span>
            <i class="fas fa-times" onclick="closeModal()" style="cursor:pointer; color:var(--txt-sec)"></i>
        </div>
        <form id="txForm" class="m-body">
            <div class="type-selector">
                <button type="button" class="ts-btn active exp" id="btnExp" onclick="setType('exp')">Gasto</button>
                <button type="button" class="ts-btn" id="btnInc" onclick="setType('inc')">Ingreso</button>
            </div>
            <input type="hidden" id="fType" value="exp">

            <div class="form-row">
                <div>
                    <label class="f-label">Monto</label>
                    <input type="number" id="fAmt" class="f-input num" step="0.01" required placeholder="$0.00">
                </div>
                <div>
                    <label class="f-label">Fecha</label>
                    <input type="date" id="fDate" class="f-input" required>
                </div>
            </div>

            <div class="f-group">
                <label class="f-label">Categoría</label>
                <div class="chips-container" id="chipBox"></div>
                <input type="hidden" id="fCat" required>
            </div>

            <div class="f-group">
                <label class="f-label">Concepto / Detalle</label>
                <input type="text" id="fDesc" class="f-input" list="dlConc" required placeholder="Detalle...">
                <datalist id="dlConc"></datalist>
            </div>

            <div class="f-group" id="linkRow">
                <label class="f-label" style="color:var(--primary)">Pagar con (Fuente)</label>
                <select id="fLink" class="f-input"></select>
            </div>

            <div style="display:flex; align-items:center; gap:10px; margin-bottom:24px;">
                <input type="checkbox" id="fExec" style="width:16px; height:16px; accent-color:var(--primary);">
                <label for="fExec" style="font-weight:500; font-size:11px;">Marcar como Ejecutado</label>
            </div>

            <button type="submit" class="btn-primary">GUARDAR</button>
            <button type="button" id="btnDel" onclick="delTx()" style="background:transparent; color:var(--danger); border:none; width:100%; margin-top:12px; cursor:pointer; font-weight:600; display:none; font-size:11px;">Eliminar Registro</button>
        </form>
    </div>
</div>

<script>
    /* --- CONFIG & STATE --- */
    const API_URL = "https://script.google.com/macros/s/AKfycbxEni9GJ4gxmbhmNsbzoYxS_SfhcorqsXj4zh93-qWIy5i2R4jwvgJ8L25GcU3h3Bkh/exec";
    const MONTHS = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    // Nordic Palette for Charts
    const PALETTE = ['#5E81AC','#81A1C1','#88C0D0','#A3BE8C','#BF616A','#D08770','#EBCB8B','#B48EAD'];

    let appData = { txs: [], cats: { exp:[], inc:[] }, concepts: {}, rates: {} };
    let currentDate = new Date(); currentDate.setDate(1);
    let editId=null, cFlow=null, cExp=null, cInc=null, drillCat=null;
    const fmt = (n) => n.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

    /* --- INIT --- */
    window.onload = () => { updateDateUI(); forceSync(); };

    async function forceSync() {
        try { const r = await fetch(API_URL); appData = await r.json(); if(!appData.rates) appData.rates={}; loadMonthData(); } catch(e){ console.error(e); }
    }
    
    async function saveData() {
        try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(appData) }); loadMonthData(); } catch(e){ alert('Error guardando'); }
    }

    function loadMonthData() {
        const y = currentDate.getFullYear(), m = currentDate.getMonth() + 1;
        document.getElementById('usdRate').value = appData.rates[`${y}-${m.toString().padStart(2,'0')}`] || 1200;
        
        const txs = appData.txs.filter(t => !t.deletedAt && parseInt(t.date.split('-')[0]) === y && parseInt(t.date.split('-')[1]) === m);
        txs.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id);

        renderLists(txs);
        renderCharts(txs);
        updateKPIs(txs);
    }

    /* --- RENDERERS --- */
    function renderLists(txs) {
        const lI=document.getElementById('list-inc'), lE=document.getElementById('list-exp'), lA=document.getElementById('list-alloc');
        lI.innerHTML=''; lE.innerHTML=''; lA.innerHTML=''; let rb=0;

        txs.forEach(t => {
            if(t.type=='inc') rb+=t.amount; else rb-=t.amount;
            const el = document.createElement('div');
            el.className = `tx-row ${t.exec?'executed':''}`;
            el.onclick = () => editTx(t.id);
            el.innerHTML = `
                <div class="tx-left">
                    <div class="tx-desc">${t.desc}</div>
                    <div class="tx-meta"><span class="badge">${t.cat}</span> <span>${t.date.split('-')[2]} ${MONTHS[parseInt(t.date.split('-')[1])-1].substring(0,3)}</span> ${t.type=='exp'&&t.linkId?'<i class="fas fa-link"></i>':''}</div>
                </div>
                <div style="text-align:right">
                    <div class="num" style="font-size:12px; color:var(--${t.type=='inc'?'success':'danger'})">$${fmt(t.amount)}</div>
                    ${t.type=='exp'?`<div style="font-size:9px; color:${rb>=0?'var(--success)':'var(--danger)'}">Q: $${fmt(rb)}</div>`:''}
                </div>
            `;
            (t.type=='inc'?lI:lE).appendChild(el);
        });
        document.getElementById('c-inc').innerText = txs.filter(t=>t.type=='inc').length;
        document.getElementById('c-exp').innerText = txs.filter(t=>t.type=='exp').length;

        // Allocations
        const incs = txs.filter(t=>t.type=='inc');
        if(!incs.length) lA.innerHTML = '<div style="padding:20px; text-align:center; color:#9CA3AF; font-size:11px;">Sin ingresos</div>';
        
        incs.forEach(inc => {
            const subs = txs.filter(t=>t.type=='exp' && t.linkId==inc.id);
            const spent = subs.reduce((a,b)=>a+b.amount,0);
            const rem = inc.amount - spent;
            const pct = Math.min(100, (spent/inc.amount)*100);
            const color = rem < 0 ? '#DC2626' : (pct>90 ? '#D97706' : '#059669'); 

            let rows = '';
            subs.forEach(s => rows += `<div style="display:flex; justify-content:space-between; padding:4px 0; font-size:10px; border-bottom:1px dashed #eee; ${s.exec?'text-decoration:line-through; opacity:0.6':''}" onclick="editTx(${s.id})"><span>${s.desc}</span><span class="num">$${fmt(s.amount)}</span></div>`);

            lA.innerHTML += `
                <div class="alloc-item">
                    <div class="ai-header" onclick="this.parentElement.classList.toggle('open')" style="cursor:pointer">
                        <span>${inc.desc}</span>
                        <span class="num">$${fmt(inc.amount)}</span>
                    </div>
                    <div class="ai-bar-bg">
                        <div class="ai-bar-fill" style="width:${pct}%; background:${color}"></div>
                    </div>
                    <div class="ai-stats">
                        <span>Gastado: $${fmt(spent)} (${Math.round(pct)}%)</span>
                        <span style="font-weight:600; color:${color}">Restan: $${fmt(rem)}</span>
                    </div>
                    <div class="ai-details">${rows || 'Sin asignaciones'}</div>
                </div>
            `;
        });
    }

    function renderCharts(txs) {
        renderDoughnut(document.getElementById('chartExp'), document.getElementById('legExp'), txs.filter(t=>t.type=='exp'), 'cat', true, cExp, i=>cExp=i);
        renderDoughnut(document.getElementById('chartInc'), document.getElementById('legInc'), txs.filter(t=>t.type=='inc'), 'desc', false, cInc, i=>cInc=i);

        const days = new Date(currentDate.getFullYear(), currentDate.getMonth()+1, 0).getDate();
        const lbs = Array.from({length:days},(_,i)=>i+1);
        const dInc = new Array(days).fill(0), dExp = new Array(days).fill(0);
        txs.forEach(t=>{ const d=parseInt(t.date.split('-')[2])-1; if(d>=0) t.type=='inc'?dInc[d]+=t.amount:dExp[d]+=t.amount; });

        if(cFlow) cFlow.destroy();
        cFlow = new Chart(document.getElementById('chartFlow'), {
            type: 'bar',
            data: { labels:lbs, datasets:[{label:'Ing',data:dInc,backgroundColor:'#A3BE8C',borderRadius:2},{label:'Gas',data:dExp,backgroundColor:'#BF616A',borderRadius:2}] },
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{grid:{display:false}}, y:{beginAtZero:true, grid:{color:'#F1F5F9'}}}, plugins:{legend:{align:'end', labels:{boxWidth:8, usePointStyle:true}}} }
        });
    }

    function renderDoughnut(cvs, leg, data, key, drill, inst, setInst) {
        if(inst) inst.destroy();
        let map={};
        if(drill && drillCat) data.filter(t=>t.cat==drillCat).forEach(t=>map[t.desc]=(map[t.desc]||0)+t.amount);
        else data.forEach(t=>map[t[key]]=(map[t[key]]||0)+t.amount);
        
        const ent = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        const tot = ent.reduce((a,b)=>a+b[1],0);
        
        setInst(new Chart(cvs, {
            type:'doughnut', 
            data:{ labels:ent.map(e=>e[0]), datasets:[{data:ent.map(e=>e[1]), backgroundColor:PALETTE, borderWidth:0}] },
            options:{ responsive:true, maintainAspectRatio:false, cutout:'80%', plugins:{legend:{display:false}}, onClick:(e,el)=>{if(drill&&!drillCat&&el.length){drillCat=ent[el[0].index][0]; loadMonthData();}} }
        }));

        leg.innerHTML = '';
        ent.forEach((e,i) => {
            leg.innerHTML += `
                <div class="cl-item" onclick="${drill&&!drillCat?`drillCat='${e[0]}';loadMonthData()`:''}">
                    <div style="display:flex; align-items:center;"><div class="cl-dot" style="background:${PALETTE[i%PALETTE.length]}"></div> <span>${e[0]}</span></div>
                    <div class="num" style="font-size:10px;">${Math.round((e[1]/tot)*100)}%</div>
                </div>`;
        });
    }
    
    function resetCharts() { drillCat=null; loadMonthData(); }

    /* --- FORM & ACTIONS --- */
    function openModal(){ editId=null; resetForm(); setType('exp'); document.getElementById('modalOverlay').classList.add('open'); }
    function closeModal(e){ if(!e || e.target.id=='modalOverlay' || e.target.tagName=='I') document.getElementById('modalOverlay').classList.remove('open'); }
    
    function setType(t){
        document.getElementById('fType').value=t;
        document.getElementById('btnExp').className=`ts-btn ${t=='exp'?'active exp':''}`;
        document.getElementById('btnInc').className=`ts-btn ${t=='inc'?'active inc':''}`;
        
        const box=document.getElementById('chipBox'); box.innerHTML='';
        (appData.cats[t]||[]).forEach(c=>{
            const el=document.createElement('div'); el.className='chip'; el.innerText=c;
            el.onclick=()=>selectCat(c,el); box.appendChild(el);
        });
        const add=document.createElement('div'); add.className='chip add'; add.innerText='+';
        add.onclick=()=>{const n=prompt('Nueva Categoría'); if(n){ if(!appData.cats[t])appData.cats[t]=[]; appData.cats[t].push(n); saveData(); setType(t); }};
        box.appendChild(add);

        document.getElementById('linkRow').style.display=t=='exp'?'block':'none';
        if(t=='exp') renderLinkOpts();
        
        const dl=document.getElementById('dlConc'); dl.innerHTML='';
        Object.values(appData.concepts).flat().forEach(c=>dl.appendChild(new Option(c)));
    }

    function selectCat(c, el){ document.getElementById('fCat').value=c; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); if(el) el.classList.add('active'); }

    function renderLinkOpts(sel){
        const s=document.getElementById('fLink'); s.innerHTML='<option value="">-- Sin Asignar --</option>';
        const y=currentDate.getFullYear(), m=currentDate.getMonth()+1;
        appData.txs.filter(t=>!t.deletedAt && t.type=='inc' && parseInt(t.date.split('-')[1])==m).forEach(i=>{
            const sp=appData.txs.filter(x=>!x.deletedAt && x.type=='exp' && x.linkId==i.id && x.id!=editId).reduce((a,b)=>a+b.amount,0);
            s.add(new Option(`${i.desc} (Disp: $${fmt(i.amount-sp)})`, i.id));
        });
        if(sel)s.value=sel;
    }

    document.getElementById('txForm').onsubmit=e=>{
        e.preventDefault();
        const cat=document.getElementById('fCat').value, desc=document.getElementById('fDesc').value;
        if(!cat)return alert('Selecciona categoría');
        const tx={
            id:editId||Date.now(), date:document.getElementById('fDate').value,
            amount:parseFloat(document.getElementById('fAmt').value), type:document.getElementById('fType').value,
            cat, desc, exec:document.getElementById('fExec').checked,
            linkId:document.getElementById('fType').value=='exp'?document.getElementById('fLink').value:null, deletedAt:null
        };
        if(!appData.concepts[cat])appData.concepts[cat]=[]; if(!appData.concepts[cat].includes(desc))appData.concepts[cat].push(desc);
        if(editId){ const i=appData.txs.findIndex(x=>x.id==editId); appData.txs[i]=tx; } else appData.txs.push(tx);
        saveData(); closeModal({target:document.getElementById('modalOverlay')});
    }

    function editTx(id){
        const t=appData.txs.find(x=>x.id==id); if(!t)return; editId=id;
        document.getElementById('mTitle').innerText='Editar'; document.getElementById('btnDel').style.display='block';
        document.getElementById('fAmt').value=t.amount; document.getElementById('fDate').value=t.date; document.getElementById('fDesc').value=t.desc; document.getElementById('fExec').checked=t.exec;
        setType(t.type); 
        const cs=document.querySelectorAll('.chip'); for(let c of cs)if(c.innerText==t.cat)selectCat(t.cat,c);
        if(t.type=='exp')renderLinkOpts(t.linkId);
        document.getElementById('modalOverlay').classList.add('open');
    }

    function resetForm(){ document.getElementById('txForm').reset(); document.getElementById('mTitle').innerText='Nuevo'; document.getElementById('btnDel').style.display='none'; document.getElementById('fDate').value=new Date().toISOString().split('T')[0]; }
    
    /* --- ADMIN --- */
    function delTx(){ if(confirm('¿Eliminar?')){ appData.txs.find(x=>x.id==editId).deletedAt=Date.now(); saveData(); closeModal({target:document.getElementById('modalOverlay')}); }}
    function clearMonth(){ if(confirm('¿BORRAR TODO EL MES?')){ const y=currentDate.getFullYear(), m=currentDate.getMonth()+1; appData.txs.forEach(t=>{if(parseInt(t.date.split('-')[0])==y && parseInt(t.date.split('-')[1])==m) t.deletedAt=Date.now();}); saveData(); }}
    function cloneMonth(){ const s=document.getElementById('cloneSrc').value; if(!s)return alert('Mes origen?'); if(!confirm('¿Copiar?')){return;} const [sy,sm]=s.split('-').map(Number); const src=appData.txs.filter(t=>!t.deletedAt && parseInt(t.date.split('-')[0])==sy && parseInt(t.date.split('-')[1])==sm); const tgt=document.getElementById('datePicker').value+'-01'; let map={}, n=[]; src.filter(t=>t.type=='inc').forEach(t=>{const id=Date.now()+Math.random(); map[t.id]=id; n.push({...t,id,date:tgt,exec:false});}); src.filter(t=>t.type=='exp').forEach(t=>{const id=Date.now()+Math.random(); n.push({...t,id,date:tgt,exec:false,linkId:t.linkId?map[t.linkId]:null});}); appData.txs.push(...n); saveData(); }
    
    /* --- HELPERS --- */
    function updateKPIs(txs){
        const tc=parseFloat(document.getElementById('usdRate').value)||1200;
        const i=txs.filter(t=>t.type=='inc').reduce((a,b)=>a+b.amount,0);
        const e=txs.filter(t=>t.type=='exp').reduce((a,b)=>a+b.amount,0);
        document.getElementById('k-inc').innerText='$'+fmt(i); document.getElementById('k-exp').innerText='$'+fmt(e);
        document.getElementById('k-bal').innerText='$'+fmt(i-e); document.getElementById('k-usd').innerText='USD '+fmt((i-e)/tc);
    }
    function changeMonth(d){ currentDate.setMonth(currentDate.getMonth()+d); updateDateUI(); loadMonthData(); }
    function manualDate(){ const[y,m]=document.getElementById('datePicker').value.split('-'); currentDate.setFullYear(y); currentDate.setMonth(m-1); updateDateUI(); loadMonthData(); }
    function updateDateUI(){ document.getElementById('monthTxt').innerText=`${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`; document.getElementById('datePicker').value=`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`; }
    function updateTC() { appData.rates[`${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`]=document.getElementById('usdRate').value; saveData(); }
    function nav(v, el){ document.querySelectorAll('.view-container').forEach(e=>e.classList.remove('active')); document.getElementById(`view-${v}`).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); if(el)el.classList.add('active'); }
</script>
</body>
</html>
